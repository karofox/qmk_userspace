oled_rotation_t oled_init_user(oled_rotation_t rotation) { return OLED_ROTATION_270; }

static const char PROGMEM karofox_avatar[] = {
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7c, 0xbc, 0xb8, 0xd8, 0xd0, 0xe0, 0xe0, 0xf0, 
	0xf0, 0xe0, 0xe0, 0xd0, 0xd8, 0xb8, 0xbc, 0x7c, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x07, 0x07, 0x0f, 0x0f, 0x1f, 0x1f, 0x3f, 0x7f, 0x6f, 
	0x6f, 0x7f, 0x3f, 0x1f, 0x1f, 0x0f, 0x0f, 0x07, 0x07, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static void render_avatar(void) {
    oled_write_raw_P(karofox_avatar, sizeof(karofox_avatar));
}

/* FOX ANIMATION START */
#define MIN_WALK_SPEED 10
#define MIN_RUN_SPEED 50

#define ANIM_FRAME_DURATION 100
#define ANIM_SIZE 64
#define ANIM_FRAME_COUNT 12

uint32_t anim_timer = 0;
uint8_t current_frame = 0;
int current_wpm = 0;

static void render_fox(int fox_x, int fox_y) {
    static const char PROGMEM walk[ANIM_FRAME_COUNT][ANIM_SIZE] = {
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0x78, 0x40, 0x60, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x20, 0x30, 0x38, 0x38, 0x1c, 0x1e, 0x0f, 0x03, 0x00, 0xf9, 0x9f, 0x77, 0x07, 0x01, 
            0x73, 0xdf, 0x0f, 0x07, 0x07, 0x1f, 0x1f, 0x60, 0x80, 0x80, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf8, 0x48, 0x60, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x10, 0x18, 0x1c, 0x1e, 0x0f, 0x07, 0xf9, 0x99, 0x0f, 0x07, 0x1f, 0x37, 0x43, 
            0x63, 0x1f, 0x07, 0x07, 0x0f, 0x1b, 0x73, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf8, 0xc8, 0xe0, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x08, 0x18, 0x1c, 0x1e, 0x0e, 0xc7, 0xbb, 0x09, 0x0f, 0x07, 0x07, 0x03, 0x1f, 0x67, 
            0x83, 0x43, 0x3f, 0x0f, 0x0b, 0x7f, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf8, 0xc8, 0xe0, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x08, 0x0c, 0x0c, 0x0e, 0x0e, 0x6f, 0x77, 0x19, 0x0c, 0x0f, 0x0f, 0x1f, 0x7f, 0x83, 0x03, 
            0x03, 0x03, 0x03, 0x07, 0xff, 0xbb, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf0, 0x40, 0xe0, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x18, 0x18, 0x1c, 0x1c, 0x0e, 0x67, 0x33, 0x18, 0x0d, 0x1f, 0xff, 0x87, 0x03, 0x03, 
            0x03, 0x03, 0x03, 0xff, 0x8f, 0x0f, 0x0f, 0x08, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf0, 0x40, 0x60, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x10, 0x18, 0x18, 0x1c, 0x0e, 0x0f, 0x03, 0x60, 0x1d, 0xff, 0x87, 0x07, 
            0x01, 0x03, 0x63, 0xbf, 0x0f, 0x07, 0x0f, 0x1f, 0x10, 0x60, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
        0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0x78, 0x40, 0x60, 0x00, 0x00, 0x00, 0x00, 
        0x00, 0x00, 0x00, 0x10, 0x10, 0x18, 0x1c, 0x0e, 0x07, 0x03, 0x00, 0xf9, 0x9f, 0x37, 0x07, 0x03, 
        0x03, 0x7f, 0x0f, 0x07, 0x07, 0x0f, 0x1f, 0x70, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf8, 0x40, 0x60, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x10, 0x18, 0x1c, 0x0e, 0x0f, 0x07, 0x41, 0xf8, 0x0b, 0x0f, 0x1f, 0x1f, 0x61, 
            0x43, 0x03, 0x67, 0x3f, 0x07, 0x1f, 0x7b, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf8, 0xc8, 0xe0, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x08, 0x0c, 0x0c, 0x0e, 0x0e, 0x07, 0xc3, 0xb1, 0x19, 0x0f, 0x0f, 0x07, 0x1f, 0x67, 
            0xc3, 0x03, 0x03, 0x03, 0x2f, 0x7f, 0xc3, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf8, 0xc8, 0xe0, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x08, 0x0c, 0x0c, 0x0e, 0x0e, 0x6f, 0x1f, 0x09, 0x0d, 0x0f, 0x07, 0x17, 0x7f, 0x83, 
            0x03, 0x03, 0x03, 0x07, 0x7f, 0x8f, 0x8f, 0x78, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xf0, 0x40, 0x60, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x18, 0x18, 0x1c, 0x1c, 0x0e, 0x7f, 0x0f, 0x04, 0x07, 0x07, 0x7f, 0xcf, 0x03, 
            0x03, 0x03, 0x03, 0xff, 0x8f, 0x0f, 0x0f, 0x18, 0x30, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 
            0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0x70, 0x40, 0x60, 0x80, 0x00, 0x00, 0x00, 
            0x00, 0x00, 0x10, 0x10, 0x18, 0x1c, 0x1c, 0x1e, 0x07, 0x7f, 0x04, 0x07, 0x1f, 0xff, 0x87, 0x01, 
            0x03, 0x03, 0xff, 0x9f, 0x07, 0x0f, 0x1f, 0x30, 0x60, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00
        }
    };

    static const char PROGMEM run[ANIM_FRAME_COUNT][ANIM_SIZE] = {
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 
	        0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xf0, 0x78, 0x38, 0x3a, 0x34, 0x18, 0x00, 0x20, 0x00, 
	        0x00, 0x00, 0x00, 0x10, 0x1c, 0x0e, 0x3f, 0x17, 0x0b, 0x05, 0x05, 0x7e, 0x8f, 0x0f, 0x07, 0x03, 
	        0x01, 0x01, 0x01, 0x03, 0x07, 0x07, 0x03, 0x1f, 0x06, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0xc0, 0xe0, 0xf0, 0x70, 0x70, 0x30, 0x30, 0xb0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 
            0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf0, 0xf0, 0x70, 0x30, 0x38, 0x24, 0x30, 0x20, 0x40, 0x00, 
            0x00, 0x01, 0x00, 0x00, 0x02, 0x18, 0x0d, 0x07, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 
            0x01, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03, 0x07, 0x06, 0x06, 0x06, 0x1c, 0x04, 0x02, 0x00, 0x00
        },
        {
            0x00, 0x08, 0x0c, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x8c, 0x8c, 0x8c, 0xd8, 0xf8, 0xf8, 0xf8, 0xf8, 
            0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0x70, 0x70, 0x70, 0x60, 0x70, 0xc0, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x07, 0x03, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 
            0x00, 0x01, 0x01, 0x01, 0x01, 0x0f, 0x0f, 0x1b, 0x66, 0x46, 0x46, 0x04, 0x0c, 0x04, 0x04, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x02, 0x06, 0x0e, 0x0e, 0x0e, 0x0c, 0x1c, 0x18, 0x10, 0xf0, 0xf8, 0xf8, 0xf0, 
            0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe8, 0xe0, 0xd0, 0xe0, 0x00, 0x80, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x0e, 0x1f, 0x03, 0x01, 
            0x61, 0x9d, 0x0f, 0x07, 0x0f, 0x1f, 0x37, 0x61, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x02, 0x1c, 0x38, 0x70, 0x70, 0x60, 0x60, 0x60, 0x60, 0x60, 0xe0, 0xf0, 0xf0, 0xf0, 
            0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe8, 0xe0, 0x40, 0x60, 0xc0, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x17, 
	        0x1f, 0x7f, 0x9f, 0x17, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x40, 0xc0, 0x80, 0x80, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0xf0, 0xf0, 
            0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf0, 0xf0, 0xf0, 0x70, 0x74, 0x70, 0x30, 0x30, 0x60, 0x20, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 0x3f, 0xdf, 
            0x9b, 0x0f, 0x19, 0x13, 0x33, 0x1d, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0xe0, 
	        0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xf0, 0x78, 0x38, 0x3a, 0x34, 0x18, 0x00, 0x20, 0x00, 
	        0x00, 0x00, 0x00, 0x10, 0x1c, 0x0e, 0x3f, 0x17, 0x0b, 0x05, 0x05, 0x7e, 0x8f, 0x0f, 0x07, 0x03, 
	        0x01, 0x01, 0x01, 0x03, 0x07, 0x07, 0x03, 0x1f, 0x06, 0x02, 0x02, 0x02, 0x02, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0xc0, 0xe0, 0xf0, 0x70, 0x70, 0x30, 0x30, 0xb0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 
            0xf0, 0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf0, 0xf0, 0x70, 0x30, 0x38, 0x24, 0x30, 0x20, 0x40, 0x00, 
            0x00, 0x01, 0x00, 0x00, 0x02, 0x18, 0x0d, 0x07, 0x03, 0x03, 0x03, 0x01, 0x01, 0x00, 0x00, 0x00, 
            0x01, 0x01, 0x01, 0x01, 0x01, 0x03, 0x03, 0x07, 0x06, 0x06, 0x06, 0x1c, 0x04, 0x02, 0x00, 0x00
        },
        {
            0x00, 0x08, 0x0c, 0x0e, 0x0e, 0x0e, 0x0e, 0x0e, 0x8c, 0x8c, 0x8c, 0xd8, 0xf8, 0xf8, 0xf8, 0xf8, 
            0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0x70, 0x70, 0x70, 0x60, 0x70, 0xc0, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x06, 0x07, 0x03, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 
            0x00, 0x01, 0x01, 0x01, 0x01, 0x0f, 0x0f, 0x1b, 0x66, 0x46, 0x46, 0x04, 0x0c, 0x04, 0x04, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x02, 0x06, 0x0e, 0x0e, 0x0e, 0x0c, 0x1c, 0x18, 0x10, 0xf0, 0xf8, 0xf8, 0xf0, 
            0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe0, 0xe8, 0xe0, 0xd0, 0xe0, 0x00, 0x80, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x12, 0x0e, 0x1f, 0x03, 0x01, 
            0x61, 0x9d, 0x0f, 0x07, 0x0f, 0x1f, 0x37, 0x61, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x02, 0x1c, 0x38, 0x70, 0x70, 0x60, 0x60, 0x60, 0x60, 0x60, 0xe0, 0xf0, 0xf0, 0xf0, 
            0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xe8, 0xe0, 0x40, 0x60, 0xc0, 0x00, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x11, 0x17, 
	        0x1f, 0x7f, 0x9f, 0x17, 0x03, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        },
        {
            0x00, 0x00, 0x00, 0x40, 0xc0, 0x80, 0x80, 0x80, 0x80, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 0xf0, 0xf0, 
            0xf0, 0xf0, 0xf8, 0xf8, 0xf8, 0xf0, 0xf0, 0xf0, 0x70, 0x74, 0x70, 0x30, 0x30, 0x60, 0x20, 0x00, 
            0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x01, 0x3f, 0xdf, 
            0x9b, 0x0f, 0x19, 0x13, 0x33, 0x1d, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
        }
    };

    void animate_fox(void) {
        current_frame = (current_frame + 1) % ANIM_FRAME_COUNT;

        if (current_wpm <= MIN_WALK_SPEED) {
            render_avatar();
        } else if (current_wpm <= MIN_RUN_SPEED) {
            oled_write_raw_P(walk[current_frame], ANIM_SIZE);
        } else {
            oled_write_raw_P(run[current_frame], ANIM_SIZE);
        }
    }

    #if OLED_TIMEOUT > 0
    if (last_input_activity_elapsed() > OLED_TIMEOUT && last_led_activity_elapsed() > OLED_TIMEOUT) {
        oled_off();
        return;
    } else {
        oled_on();
    }
    #endif

    if (timer_elapsed32(anim_timer) > ANIM_FRAME_DURATION) {
        anim_timer = timer_read32();
        animate_fox();
    }
}

static void print_master_pane(void) {
    uint8_t wpm = get_current_wpm();
    char wpm_str[4];
    oled_set_cursor(0, 10);
    wpm_str[3] = '\0';
    wpm_str[2] = '0' + wpm % 11;
    wpm_str[1] = '0' + (wpm /= 10) % 10;
    wpm_str[0] = '0' + wpm / 10;
    oled_write(wpm_str, false);
    oled_set_cursor(0,11);
    oled_write(" wpm", false);
    oled_set_cursor(0, 16);
    render_fox(0, 16);
}


bool oled_task_user(void) {
    current_wpm = get_current_wpm();

    if (is_keyboard_master()) {
        print_master_pane();
    } else {
        render_avatar();
    }
    return false;
}
